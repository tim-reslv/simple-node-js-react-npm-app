# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main

pool: Default
#  vmImage: ubuntu-latest

steps:
- task: JavaToolInstaller@0
  inputs:
    #versionSpec: '8' 
    jdkArchitectureOption: x64 # Options: x64, x86
    jdkSourceOption: AzureStorage # Options: AzureStorage, LocalDirectory
    #jdkFile: # Required when jdkSourceOption == LocalDirectory
    #azureResourceManagerEndpoint: # Required when jdkSourceOption == AzureStorage
    #azureStorageAccountName: # Required when jdkSourceOption == AzureStorage
    #azureContainerName: # Required when jdkSourceOption == AzureStorage
    #azureCommonVirtualFile: # Required when jdkSourceOption == AzureStorage
    jdkDestinationDirectory: 
    #cleanDestinationDirectory: true 
- task: NodeTool@0
  inputs:
    versionSpec: '10.x'
  displayName: 'Install Node.js'

- script: |
    npm install
  displayName: 'npm install'

- task: SonarQubePrepare@4
  inputs:
    SonarQube: 'sonarqube'
    scannerMode: 'CLI'
    configMode: 'manual'
    cliProjectKey: 'pwc_pwc'

- script: |
    npm run build
  displayName: 'npm build'

# Run Code Analysis task
- task: SonarQubeAnalyze@4

# Publish Quality Gate Result task
- task: SonarQubePublish@4
  inputs:
    pollingTimeoutSec: '300'

- task: Docker@2
  displayName: Build docker image
  inputs:
    repository: pwc/simple-node-js-react-npm-app
    containerRegistry: docker_reslv_io
    command: build
    Dockerfile: Dockerfile
    tags: latest

- task: Docker@2
  displayName: Push docker image
  inputs:
    repository: pwc/simple-node-js-react-npm-app
    containerRegistry: docker_reslv_io
    command: push
    Dockerfile: Dockerfile
    tags: latest
